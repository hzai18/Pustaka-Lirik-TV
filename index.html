<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Mursyidul Amin TV - Studio Broadcast</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1a1a; --bg-sidebar: #111; --text-light: #fff; --text-dim: #ccc;
            --accent: #d4af37; --accent-hover: #b5952f; --danger: #e74c3c; --success: #27ae60;
            --arabic-size: 55px; --arabic-color: #ffffff;
            --latin-size: 28px; --latin-color: #eeeeee;
            --bg-main-color: #333333; --bg-image: none;
            --overlay-color: 0, 0, 0; --overlay-opacity: 0.5; 
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-sidebar); color: var(--text-light); display: flex; overflow: hidden; }

        /* --- SISTEM MODE PENGGUNA & EDITOR --- */
        #btn-mode-toggle { background-color: #34495e; color: white; border: none; padding: 10px; width: 100%; font-weight: bold; border-radius: 5px; cursor: pointer; transition: 0.3s; margin-bottom: 10px; }
        #btn-mode-toggle:hover { background-color: #2c3e50; }
        body.mode-editor #btn-mode-toggle { background-color: var(--danger); }
        body.mode-editor #btn-mode-toggle:hover { background-color: #c0392b; }

        /* Sembunyikan tombol edit/tambah jika di Mode Pengguna */
        body.mode-pengguna .btn-tambah-menu { display: none; }
        body.mode-pengguna .btn-edit { display: none; }
        body.mode-pengguna .btn-hapus { display: none; }

        /* --- SPLASH SCREEN --- */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #111; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s ease-out; }
        #splash-screen img { width: 300px; margin-bottom: 30px; animation: pulse 2s infinite; }
        #splash-screen h1 { color: var(--accent); font-size: 32px; letter-spacing: 2px; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); text-align: center; }
        .creator-credit { position: absolute; bottom: 20px; font-size: 12px; color: #666; letter-spacing: 1px; font-weight: bold; }
        @keyframes pulse { 0% { transform: scale(0.95); } 50% { transform: scale(1.05); } 100% { transform: scale(0.95); } }

        /* --- UI UTAMA (EDITOR) --- */
        .sidebar { width: 320px; background-color: var(--bg-sidebar); border-right: 2px solid #333; display: flex; flex-direction: column; overflow-y: auto; z-index: 10; position: relative; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #333; text-align: center; }
        .sidebar-header h2 { margin: 0 0 15px 0; color: var(--accent); font-size: 22px; }
        .btn-tambah-menu { background-color: var(--accent); color: #000; border: none; padding: 10px; width: 100%; font-weight: bold; border-radius: 5px; cursor: pointer; transition: 0.3s; margin-bottom: 10px; }
        .btn-setting { background-color: #444; color: white; border: none; padding: 10px; width: 100%; font-weight: bold; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .btn-setting:hover { background-color: #555; }
        .menu-list { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .menu-btn { background: none; border: none; color: var(--text-dim); padding: 15px 20px; text-align: left; font-size: 16px; cursor: pointer; border-left: 4px solid transparent; border-bottom: 1px solid #222; }
        .menu-btn:hover, .menu-btn.active { background-color: rgba(255,255,255,0.05); color: var(--accent); border-left: 4px solid var(--accent); }
        
        .main-content { flex: 1; padding: 40px; overflow-y: auto; position: relative; background-color: #222; }
        .view-section { display: none; width: 100%; max-width: 900px; margin: 0 auto; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .header-lirik { text-align: center; margin-bottom: 30px; background: #111; border-radius: 10px; padding: 20px; border: 1px solid #333; }
        .judul-lagu { color: var(--accent); font-size: 32px; margin: 0 0 15px 0; }
        .action-buttons { display: flex; justify-content: center; gap: 10px; }
        .btn-action { color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-present { background-color: var(--success); } .btn-edit { background-color: #2980b9; } .btn-hapus { background-color: var(--danger); }
        
        .form-container { background-color: #222; padding: 30px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--accent); font-weight: bold; font-size: 14px; }
        .form-group input { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        
        .bait-editor { background: #111; padding: 15px; border: 1px solid #444; border-radius: 8px; margin-bottom: 15px; position: relative; border-left: 4px solid var(--accent); }
        .bait-editor textarea { width: 100%; background: #222; border: 1px solid #555; color: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; resize: vertical; box-sizing: border-box; }
        .arab-input { font-family: 'Amiri', serif; font-size: 24px; direction: rtl; height: 90px; }
        .latin-input { font-size: 16px; height: 70px; }
        .btn-hapus-bait { position: absolute; top: 10px; left: 10px; background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .btn-simpan { background-color: var(--success); color: white; border: none; padding: 15px; width: 100%; font-size: 18px; font-weight: bold; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .btn-tambah-bait { background-color: var(--accent); color: black; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }

        .auto-split-box { background: rgba(212, 175, 55, 0.1); border: 2px dashed var(--accent); }
        .auto-split-box textarea { width: 100%; height: 120px; background: #111; border: 1px solid #444; color: white; border-radius: 5px; padding: 10px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; line-height: 1.5;}
        .btn-magic { background-color: #8e44ad; color: white; border: none; padding: 12px; width: 100%; font-weight: bold; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-magic:hover { background-color: #9b59b6; }

        #db-status { position: absolute; bottom: 10px; left: 0; width: 100%; text-align: center; font-size: 12px; color: #888; }
        .status-dot { display: inline-block; width: 8px; height: 8px; background: orange; border-radius: 50%; margin-right: 5px; }
        .status-dot.online { background: #2ecc71; }

        .bait-preview { background-color: #111; margin-bottom: 15px; padding: 15px; border-radius: 10px; border: 1px solid #333; text-align: center; }
        .arab-prev { font-family: 'Amiri', serif; font-size: 28px; color: var(--accent); direction: rtl; line-height: 1.5; font-weight: bold; }
        .latin-prev { font-size: 16px; color: #aaa; margin-top: 10px; font-style: italic; }

        /* ========================================================== */
        /* --- MODE PRESENTASI (PPT BROADCAST STYLE) --- */
        /* ========================================================== */
        #ppt-mode { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 9999; flex-direction: row; }
        #ppt-mode.active { display: flex; }
        
        #ppt-sidebar { width: 350px; background: #111; border-right: 2px solid #333; display: flex; flex-direction: column; }
        
        #ppt-current-title { background: #1a1a1a; padding: 15px; color: var(--accent); font-size: 18px; font-weight: bold; text-align: center; border-bottom: 1px solid #333; }

        .ppt-top-controls { padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-ppt-ctrl { background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .btn-ppt-ctrl:hover { background: var(--accent); color: black; }
        .btn-ppt-exit { grid-column: span 2; background: var(--danger); border-color: var(--danger); }
        .btn-ppt-exit:hover { background: #c0392b; color: white; }
        
        #ppt-settings-panel { display: none; padding: 15px; background: #222; border-bottom: 1px solid #333; overflow-y: auto; max-height: 40vh; }
        #ppt-settings-panel.active { display: block; }
        .ppt-set-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 13px; color: var(--accent); }
        .ppt-set-group input[type="range"] { width: 60%; }
        .ppt-set-group input[type="color"] { width: 40px; height: 30px; padding: 0; border: none; cursor: pointer; }
        .ppt-set-group input[type="text"] { width: 60%; padding: 5px; background: #111; border: 1px solid #444; color: white; }

        #ppt-thumbnails { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background: #0a0a0a; }
        .ppt-thumb-wrap { display: flex; align-items: flex-start; gap: 8px; cursor: pointer; }
        .ppt-num { color: #888; font-size: 14px; margin-top: 5px; width: 15px; text-align: right; font-weight: bold; }
        
        .ppt-box { background: white; border-radius: 8px; border: 3px solid transparent; flex: 1; display: flex; flex-direction: column; padding: 12px; transition: 0.2s; position: relative; height: auto; }
        .ppt-thumb-wrap.active .ppt-box { border-color: #ff9800; box-shadow: 0 0 15px rgba(255, 152, 0, 0.6); background: #fffdf5; }
        .ppt-box-arab { font-family: 'Amiri', serif; font-size: 20px; color: black; direction: rtl; line-height: 1.6; white-space: normal; }
        .ppt-box-latin { font-size: 12px; color: #444; margin-top: 8px; white-space: normal; line-height: 1.4; font-style: italic; }

        #ppt-stage { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--bg-main-color); background-image: var(--bg-image); background-size: cover; background-position: center; position: relative; padding: 30px; transition: background 0.3s; }
        .ppt-content-wrapper { z-index: 2; display: flex; flex-direction: column; align-items: center; max-width: 85%; background-color: rgba(var(--overlay-color), var(--overlay-opacity)); backdrop-filter: blur(5px); padding: 30px 50px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: opacity 0.3s ease; }
        
        #ppt-stage.is-blank .ppt-content-wrapper { opacity: 0; pointer-events: none; }

        #ppt-arabic { font-family: 'Amiri', serif; font-size: var(--arabic-size); color: var(--arabic-color); direction: rtl; line-height: 1.6; font-weight: bold; margin-bottom: 20px; text-shadow: 2px 2px 5px rgba(0,0,0,0.3); text-align: center; }
        #ppt-latin { font-size: var(--latin-size); color: var(--latin-color); font-style: italic; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); text-align: center; }

        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
    </style>
</head>
<body class="mode-pengguna"> <div id="splash-screen">
        <img src="https://raw.githubusercontent.com/hzai18/Pustaka-Lirik-TV/refs/heads/main/gold.png" alt="Logo Al-Mursyidul Amin" onerror="this.style.display='none'">
        <h1>PUSTAKA SYAIR AL-MURSYIDUL AMIN TV</h1>
        <p style="color: #666; margin-top: 10px; font-style: italic;">Memuat Database Cloud...</p>
        <div class="creator-credit">Created by : Huzaifi</div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Al-Mursyidul Amin TV</h2>
            <button id="btn-mode-toggle" onclick="toggleMode()">üîí Mode Pengguna (Terkunci)</button>
            <button class="btn-tambah-menu" onclick="bukaFormTambah()">‚ûï Tambah Lirik Baru</button>
            <button class="btn-setting" onclick="bukaPengaturan()">‚öôÔ∏è Pengaturan Tampilan</button>
        </div>
        <div class="menu-list" id="menu-list">
            <p style="text-align:center; color:#888; margin-top: 20px;">Menyelaraskan data...</p>
        </div>
        <div id="db-status"><span class="status-dot" id="dot-status"></span> <span id="text-status">Menghubungkan...</span></div>
    </div>

    <div class="main-content">
        <div id="view-lirik" class="view-section active">
            <div class="header-lirik">
                <h1 class="judul-lagu" id="display-judul">Harap Tunggu...</h1>
                <div class="action-buttons" id="action-buttons" style="display: none;">
                    <button class="btn-action btn-present" onclick="masukPresentasi()">‚ñ∂Ô∏è Mode Presentasi (PPT)</button>
                    <button class="btn-action btn-edit" onclick="editLaguSaatIni()">‚úèÔ∏è Edit Lirik</button>
                    <button class="btn-action btn-hapus" onclick="hapusLaguSaatIni()">üóëÔ∏è Hapus</button>
                </div>
            </div>
            <div id="display-bait-container"></div>
        </div>

        <div id="view-form" class="view-section">
            <div class="form-container auto-split-box">
                <h3 style="margin-top:0; color:var(--accent);">‚ú® Auto-Split Lirik</h3>
                <p style="font-size: 14px; color: #ddd; margin-bottom: 15px;">Paste lirik campuran (Teks Arab dan Latin menempel) di bawah ini. Sistem otomatis memotongnya.</p>
                <textarea id="bulk-input" placeholder="Paste full lirik di sini..."></textarea>
                <button class="btn-magic" onclick="prosesAutoSplit()">‚ö° Pisahkan & Buat Bait Otomatis</button>
            </div>

            <div class="form-container">
                <h2 id="form-title" style="color: var(--accent); margin-top: 0;">Editor Lirik</h2>
                <input type="hidden" id="edit-id">
                <div class="form-group"><label>Judul Sholawat / Qasidah</label><input type="text" id="input-judul" autocomplete="off" placeholder="Masukkan Judul Lagu..."></div>
                <div id="editor-baits-container"></div>
                <button class="btn-tambah-bait" onclick="tambahBaitKosong()">‚ûï Tambah Bait Kosong</button>
                <button class="btn-simpan" id="btn-save-cloud" onclick="simpanLagu()">‚òÅÔ∏è SIMPAN KE CLOUD DATABASE</button>
            </div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="form-container">
                <h2 style="color: var(--accent); margin-top: 0;">‚öôÔ∏è Pengaturan Layar Presentasi</h2>
                <div class="grid-2">
                    <div class="form-group"><label>Ukuran Teks Arab (px)</label><input type="number" id="set-arab-size" oninput="terapkanPengaturanSementara()"></div>
                    <div class="form-group"><label>Warna Teks Arab</label><input type="color" id="set-arab-color" oninput="terapkanPengaturanSementara()"></div>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label>Ukuran Teks Terjemahan (px)</label><input type="number" id="set-latin-size" oninput="terapkanPengaturanSementara()"></div>
                    <div class="form-group"><label>Warna Teks Terjemahan</label><input type="color" id="set-latin-color" oninput="terapkanPengaturanSementara()"></div>
                </div>
                <div class="form-group"><label>Warna Latar Belakang / Background</label><input type="color" id="set-bg-color" oninput="terapkanPengaturanSementara()"></div>
                <div class="form-group"><label>Gambar Latar Belakang (URL)</label><input type="text" id="set-bg-image" oninput="terapkanPengaturanSementara()"></div>
                <div class="form-group"><label>Kegelapan Kotak Teks (<span id="opacity-val">0.5</span>)</label><input type="range" id="set-overlay" min="0" max="1" step="0.05" oninput="terapkanPengaturanSementara()"></div>
                <button class="btn-simpan" onclick="simpanPengaturan()">üíæ Simpan Pengaturan</button>
            </div>
        </div>
    </div>

    <div id="ppt-mode">
        <div id="ppt-sidebar">
            <div id="ppt-current-title">Sedang Memuat...</div>

            <div class="ppt-top-controls">
                <button class="btn-ppt-ctrl" id="btn-toggle-blank" onclick="toggleBlank()">üëÅÔ∏è Hide Teks (Blank)</button>
                <button class="btn-ppt-ctrl" onclick="toggleSettingsPanel()">‚öôÔ∏è Pengaturan Tampilan</button>
                <button class="btn-ppt-ctrl btn-ppt-exit" onclick="keluarPresentasi()">‚¨ÖÔ∏è Tutup & Kembali</button>
            </div>

            <div id="ppt-settings-panel">
                <div class="ppt-set-group"><label>Size Arab</label><input type="range" id="rt-arab-size" min="20" max="100" oninput="updateRealtimeSettings()"></div>
                <div class="ppt-set-group"><label>Warna Arab</label><input type="color" id="rt-arab-color" oninput="updateRealtimeSettings()"></div>
                <div class="ppt-set-group"><label>Size Latin</label><input type="range" id="rt-latin-size" min="10" max="60" oninput="updateRealtimeSettings()"></div>
                <div class="ppt-set-group"><label>Warna Latin</label><input type="color" id="rt-latin-color" oninput="updateRealtimeSettings()"></div>
                <div class="ppt-set-group"><label>Warna BG</label><input type="color" id="rt-bg-color" oninput="updateRealtimeSettings()"></div>
                <div class="ppt-set-group"><label>URL BG Gambar</label><input type="text" id="rt-bg-image" placeholder="http..." oninput="updateRealtimeSettings()"></div>
                <div class="ppt-set-group"><label>Gelap Kotak</label><input type="range" id="rt-overlay" min="0" max="1" step="0.05" oninput="updateRealtimeSettings()"></div>
                <button style="width:100%; padding:8px; background:var(--success); color:white; border:none; border-radius:5px; margin-top:5px; cursor:pointer;" onclick="simpanPengaturanLokal()">üíæ Simpan Style Ini</button>
            </div>

            <div id="ppt-thumbnails"></div>
        </div>
        
        <div id="ppt-stage">
            <div class="ppt-content-wrapper">
                <div id="ppt-arabic"></div>
                <div id="ppt-latin"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC0g24ujDhVT4N1FhT_qZCjrn18sD4Qf-A",
            authDomain: "almursyidul-amin-lirik.firebaseapp.com",
            projectId: "almursyidul-amin-lirik",
            storageBucket: "almursyidul-amin-lirik.firebasestorage.app",
            messagingSenderId: "541655150932",
            appId: "1:541655150932:web:85d3e2888b7ee0d5e6d8c1",
            measurementId: "G-MDT4SMGL6L"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let databaseLagu = [];
        let laguAktifId = null;
        let isInitialLoad = true;
        let appMode = 'pengguna'; 

        // ==========================================
        // GANTI PIN RAHASIA ANDA DI SINI!
        const SECRET_PIN = "1234";
        // ==========================================

        const defaultSettings = { arabSize: 60, arabColor: "#ffffff", latinSize: 28, latinColor: "#eeeeee", bgColor: "#121212", bgImage: "", overlayOpacity: 0.5 };
        let appSettings = JSON.parse(localStorage.getItem('setting_lirik_aswaja')) || defaultSettings;
        
        function terapkanPengaturanRoot() { 
            const root = document.documentElement; 
            root.style.setProperty('--arabic-size', appSettings.arabSize + 'px'); 
            root.style.setProperty('--arabic-color', appSettings.arabColor); 
            root.style.setProperty('--latin-size', appSettings.latinSize + 'px'); 
            root.style.setProperty('--latin-color', appSettings.latinColor); 
            root.style.setProperty('--bg-main-color', appSettings.bgColor); 
            root.style.setProperty('--bg-image', appSettings.bgImage ? `url('${appSettings.bgImage}')` : 'none'); 
            root.style.setProperty('--overlay-opacity', appSettings.overlayOpacity); 

            document.getElementById('rt-arab-size').value = appSettings.arabSize;
            document.getElementById('rt-arab-color').value = appSettings.arabColor;
            document.getElementById('rt-latin-size').value = appSettings.latinSize;
            document.getElementById('rt-latin-color').value = appSettings.latinColor;
            document.getElementById('rt-bg-color').value = appSettings.bgColor;
            document.getElementById('rt-bg-image').value = appSettings.bgImage;
            document.getElementById('rt-overlay').value = appSettings.overlayOpacity;
            
            document.getElementById('set-arab-size').value = appSettings.arabSize;
            document.getElementById('set-arab-color').value = appSettings.arabColor;
            document.getElementById('set-latin-size').value = appSettings.latinSize;
            document.getElementById('set-latin-color').value = appSettings.latinColor;
            document.getElementById('set-bg-color').value = appSettings.bgColor;
            document.getElementById('set-bg-image').value = appSettings.bgImage;
            document.getElementById('set-overlay').value = appSettings.overlayOpacity;
            if(document.getElementById('opacity-val')) document.getElementById('opacity-val').innerText = appSettings.overlayOpacity;
        }
        terapkanPengaturanRoot();

        const q = query(collection(db, "lirik_koleksi"), orderBy("timestamp", "asc"));
        onSnapshot(q, (snapshot) => {
            databaseLagu = [];
            snapshot.forEach((doc) => { databaseLagu.push({ id: doc.id, ...doc.data() }); });
            
            document.getElementById('dot-status').classList.add('online');
            document.getElementById('text-status').innerText = "Cloud Terhubung";
            renderMenu();

            if(isInitialLoad) {
                setTimeout(() => {
                    if(databaseLagu.length > 0) {
                        laguAktifId = databaseLagu[0].id;
                        window.tampilkanLagu(laguAktifId); 
                    } else {
                        document.getElementById('display-judul').innerText = "Belum Ada Lirik di Cloud";
                        document.getElementById('action-buttons').style.display = 'none';
                    }
                }, 4500); 
                isInitialLoad = false;
            } else {
                if (laguAktifId && databaseLagu.find(l => l.id === laguAktifId)) {
                    window.tampilkanLagu(laguAktifId); 
                }
            }
        });

        // --- SISTEM LOGIN PIN ---
        window.toggleMode = function() {
            const btnToggle = document.getElementById('btn-mode-toggle');
            
            if(appMode === 'pengguna') {
                // Minta PIN jika ingin masuk ke Mode Editor
                const inputPin = prompt("üîí Masukkan PIN rahasia untuk membuka Mode Editor:");
                
                if(inputPin === SECRET_PIN) {
                    appMode = 'editor';
                    document.body.classList.remove('mode-pengguna');
                    document.body.classList.add('mode-editor');
                    btnToggle.innerText = "üîì Mode Editor Aktif (Klik untuk Kunci)";
                    // alert("Berhasil masuk ke Mode Editor!"); // Opsional
                } else if (inputPin !== null) {
                    alert("‚ùå PIN Salah! Akses ditolak.");
                }
            } else {
                // Jika sudah di Mode Editor, langsung kunci tanpa nanya PIN
                appMode = 'pengguna';
                document.body.classList.remove('mode-editor');
                document.body.classList.add('mode-pengguna');
                btnToggle.innerText = "üîí Mode Pengguna (Terkunci)";
                
                if(document.getElementById('view-form').classList.contains('active') || document.getElementById('view-settings').classList.contains('active')) {
                    if(databaseLagu.length > 0) window.tampilkanLagu(databaseLagu[0].id);
                    else sembunyikanSemuaView();
                }
            }
        };

        window.bukaFormTambah = function() {
            sembunyikanSemuaView(); document.getElementById('view-form').classList.add('active'); 
            document.getElementById('form-title').innerText = "Tambah Lirik Baru";
            document.getElementById('edit-id').value = ""; document.getElementById('input-judul').value = ""; 
            document.getElementById('editor-baits-container').innerHTML = ""; window.tambahBaitKosong();
        };

        window.tambahBaitKosong = function(arab = "", latin = "") {
            const div = document.createElement('div'); div.className = 'bait-editor'; 
            div.innerHTML = `<button class="btn-hapus-bait" onclick="this.parentElement.remove()">X Hapus Bait</button><label style="color:#aaa; font-size:14px; margin-bottom:5px; display:block; margin-top:10px;">Teks Arab</label><textarea class="arab-input" placeholder="Teks Arab...">${arab}</textarea><label style="color:#aaa; font-size:14px; margin-bottom:5px; display:block;">Teks Latin / Terjemahan</label><textarea class="latin-input" placeholder="Teks Latin...">${latin}</textarea>`; 
            document.getElementById('editor-baits-container').appendChild(div); 
        };

        window.simpanLagu = async function() {
            const judul = document.getElementById('input-judul').value.trim(); const editId = document.getElementById('edit-id').value; 
            if(!judul) return alert("Judul wajib diisi!"); 
            const baits = []; document.querySelectorAll('.bait-editor').forEach(el => { const arab = el.querySelector('.arab-input').value.trim(); const latin = el.querySelector('.latin-input').value.trim(); if(arab || latin) baits.push({ arab, latin }); }); 
            if(baits.length === 0) return alert("Belum ada bait yang dimasukkan!"); 
            
            const btnSave = document.getElementById('btn-save-cloud'); btnSave.innerText = "‚è≥ Menyimpan..."; btnSave.style.opacity = "0.5";
            try {
                if(editId) { await updateDoc(doc(db, "lirik_koleksi", editId), { judul: judul, baits: baits }); } 
                else { const docRef = await addDoc(collection(db, "lirik_koleksi"), { judul: judul, baits: baits, timestamp: serverTimestamp() }); laguAktifId = docRef.id; }
            } catch (error) { alert("Gagal menyimpan ke Cloud."); }
            btnSave.innerText = "‚òÅÔ∏è SIMPAN KE CLOUD DATABASE"; btnSave.style.opacity = "1";
        };

        window.editLaguSaatIni = function() {
            const lagu = databaseLagu.find(l => l.id === laguAktifId); if(!lagu) return; 
            sembunyikanSemuaView(); document.getElementById('view-form').classList.add('active'); 
            document.getElementById('form-title').innerText = "Edit Lirik"; document.getElementById('edit-id').value = lagu.id; document.getElementById('input-judul').value = lagu.judul; 
            document.getElementById('editor-baits-container').innerHTML = ""; lagu.baits.forEach(b => window.tambahBaitKosong(b.arab, b.latin));
        };

        window.hapusLaguSaatIni = async function() {
            if(confirm("Yakin hapus lirik ini dari seluruh perangkat?")) { try { await deleteDoc(doc(db, "lirik_koleksi", laguAktifId)); laguAktifId = null; } catch(e) { alert("Gagal menghapus."); } }
        };

        function sembunyikanSemuaView() { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active')); }
        function renderMenu() { const menuList = document.getElementById('menu-list'); menuList.innerHTML = ''; databaseLagu.forEach((lagu, idx) => { const btn = document.createElement('button'); btn.className = `menu-btn ${laguAktifId === lagu.id ? 'active' : ''}`; btn.innerText = `${idx + 1}. ${lagu.judul}`; btn.onclick = () => window.tampilkanLagu(lagu.id); menuList.appendChild(btn); }); }
        
        window.tampilkanLagu = function(id) { 
            laguAktifId = id; sembunyikanSemuaView(); document.getElementById('view-lirik').classList.add('active'); renderMenu(); 
            const lagu = databaseLagu.find(l => l.id === id); if(!lagu) return; 
            document.getElementById('action-buttons').style.display = 'flex'; document.getElementById('display-judul').innerText = lagu.judul; 
            const container = document.getElementById('display-bait-container'); container.innerHTML = ''; 
            lagu.baits.forEach(bait => { const div = document.createElement('div'); div.className = 'bait-preview'; div.innerHTML = `<div class="arab-prev">${bait.arab.replace(/\n/g, '<br>')}</div><div class="latin-prev">${bait.latin.replace(/\n/g, '<br>')}</div>`; container.appendChild(div); }); 

            if(document.getElementById('ppt-mode').classList.contains('active')) {
                window.masukPresentasi(false); 
            }
        }

        let pptBaits = []; let pptCurrentIdx = 0;
        
        window.masukPresentasi = function(resetIndex = true) { 
            const lagu = databaseLagu.find(l => l.id === laguAktifId); if (!lagu || lagu.baits.length === 0) return; 
            pptBaits = lagu.baits; 
            if(resetIndex) pptCurrentIdx = 0; 
            
            document.getElementById('ppt-current-title').innerText = lagu.judul;

            const sidebar = document.getElementById('ppt-thumbnails'); sidebar.innerHTML = ''; 
            pptBaits.forEach((bait, i) => { 
                const div = document.createElement('div'); div.className = 'ppt-thumb-wrap'; div.id = 'thumb-' + i; 
                div.onclick = () => renderSlide(i); 
                div.innerHTML = `<div class="ppt-num">${i + 1}</div><div class="ppt-box"><div class="ppt-box-arab">${bait.arab.replace(/\n/g, '<br>')}</div><div class="ppt-box-latin">${bait.latin.replace(/\n/g, '<br>')}</div></div>`; 
                sidebar.appendChild(div); 
            }); 
            
            document.getElementById('ppt-mode').classList.add('active'); 
            renderSlide(pptCurrentIdx); 
            document.addEventListener('keydown', handleKeyPPT); 
        }

        function renderSlide(index) { 
            if(index >= pptBaits.length || index < 0) return;
            pptCurrentIdx = index; 
            document.getElementById('ppt-arabic').innerHTML = pptBaits[index].arab.replace(/\n/g, '<br>'); 
            document.getElementById('ppt-latin').innerHTML = pptBaits[index].latin.replace(/\n/g, '<br>'); 
            document.querySelectorAll('.ppt-thumb-wrap').forEach(el => el.classList.remove('active')); 
            const activeThumb = document.getElementById('thumb-' + index); 
            if(activeThumb) { activeThumb.classList.add('active'); activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } 
        }

        window.keluarPresentasi = function() { document.getElementById('ppt-mode').classList.remove('active'); document.removeEventListener('keydown', handleKeyPPT); }
        
        function handleKeyPPT(e) { 
            if(e.key === 'Escape') window.keluarPresentasi(); 
            else if(e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') { e.preventDefault(); if(pptCurrentIdx < pptBaits.length - 1) renderSlide(pptCurrentIdx + 1); } 
            else if(e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); if(pptCurrentIdx > 0) renderSlide(pptCurrentIdx - 1); } 
            else if(e.key === 'b' || e.key === 'B') { e.preventDefault(); window.toggleBlank(); } 
        }

        window.toggleBlank = function() {
            const stage = document.getElementById('ppt-stage');
            const btn = document.getElementById('btn-toggle-blank');
            stage.classList.toggle('is-blank');
            if(stage.classList.contains('is-blank')) {
                btn.style.background = "var(--danger)";
                btn.innerText = "Teks Disembunyikan!";
            } else {
                btn.style.background = "#333";
                btn.innerText = "üëÅÔ∏è Hide Teks (Blank)";
            }
        }

        window.toggleSettingsPanel = function() {
            document.getElementById('ppt-settings-panel').classList.toggle('active');
        }

        window.updateRealtimeSettings = function() {
            appSettings.arabSize = document.getElementById('rt-arab-size').value;
            appSettings.arabColor = document.getElementById('rt-arab-color').value;
            appSettings.latinSize = document.getElementById('rt-latin-size').value;
            appSettings.latinColor = document.getElementById('rt-latin-color').value;
            appSettings.bgColor = document.getElementById('rt-bg-color').value;
            appSettings.bgImage = document.getElementById('rt-bg-image').value;
            appSettings.overlayOpacity = document.getElementById('rt-overlay').value;
            terapkanPengaturanRoot();
        }

        window.simpanPengaturanLokal = function() {
            localStorage.setItem('setting_lirik_aswaja', JSON.stringify(appSettings));
            alert("Pengaturan style berhasil disimpan di PC ini!");
            window.toggleSettingsPanel(); 
        }

        window.bukaPengaturan = function() { sembunyikanSemuaView(); document.getElementById('view-settings').classList.add('active'); document.getElementById('set-arab-size').value = appSettings.arabSize; document.getElementById('set-arab-color').value = appSettings.arabColor; document.getElementById('set-latin-size').value = appSettings.latinSize; document.getElementById('set-latin-color').value = appSettings.latinColor; document.getElementById('set-bg-color').value = appSettings.bgColor; document.getElementById('set-bg-image').value = appSettings.bgImage; document.getElementById('set-overlay').value = appSettings.overlayOpacity; if(document.getElementById('opacity-val')) document.getElementById('opacity-val').innerText = appSettings.overlayOpacity; };
        window.terapkanPengaturanSementara = function() { const root = document.documentElement; root.style.setProperty('--arabic-size', document.getElementById('set-arab-size').value + 'px'); root.style.setProperty('--arabic-color', document.getElementById('set-arab-color').value); root.style.setProperty('--latin-size', document.getElementById('set-latin-size').value + 'px'); root.style.setProperty('--latin-color', document.getElementById('set-latin-color').value); root.style.setProperty('--bg-main-color', document.getElementById('set-bg-color').value); const img = document.getElementById('set-bg-image').value; root.style.setProperty('--bg-image', img ? `url('${img}')` : 'none'); const opval = document.getElementById('set-overlay').value; root.style.setProperty('--overlay-opacity', opval); if(document.getElementById('opacity-val')) document.getElementById('opacity-val').innerText = opval; };
        window.simpanPengaturan = function() { appSettings = { arabSize: document.getElementById('set-arab-size').value, arabColor: document.getElementById('set-arab-color').value, latinSize: document.getElementById('set-latin-size').value, latinColor: document.getElementById('set-latin-color').value, bgColor: document.getElementById('set-bg-color').value, bgImage: document.getElementById('set-bg-image').value, overlayOpacity: document.getElementById('set-overlay').value }; localStorage.setItem('setting_lirik_aswaja', JSON.stringify(appSettings)); alert("Pengaturan Disimpan!"); terapkanPengaturanRoot(); if(laguAktifId) window.tampilkanLagu(laguAktifId); };

        window.prosesAutoSplit = function() { const bulkText = document.getElementById('bulk-input').value.trim(); if(!bulkText) return alert("Silakan paste lirik!"); const baris = bulkText.split(/\r?\n/); let pendingArab = ""; let pendingLatin = ""; baris.forEach(b => { let text = b.trim(); if (text === '') return; const matchLatin = text.match(/[a-zA-Z]/); const matchArab = text.match(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/); if (matchLatin && matchArab) { if (pendingArab || pendingLatin) { window.tambahBaitKosong(pendingArab, pendingLatin); pendingArab = ""; pendingLatin = ""; } let arabPart = ""; let latinPart = ""; if (matchArab.index < matchLatin.index) { let idx = matchLatin.index; while(idx > 0) { let prevChar = text[idx - 1]; if (/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(prevChar)) break; idx--; } arabPart = text.substring(0, idx).trim(); latinPart = text.substring(idx).trim(); } else { let idx = matchArab.index; while(idx > 0) { let prevChar = text[idx - 1]; if (/[a-zA-Z]/.test(prevChar)) break; idx--; } latinPart = text.substring(0, idx).trim(); arabPart = text.substring(idx).trim(); } arabPart = arabPart.replace(/[-/\\|\s]+$/, ''); window.tambahBaitKosong(arabPart, latinPart); } else if (matchArab && !matchLatin) { if (pendingArab) { window.tambahBaitKosong(pendingArab, pendingLatin); pendingLatin = ""; } pendingArab = text; } else if (matchLatin && !matchArab) { if (pendingArab) { pendingLatin = text; window.tambahBaitKosong(pendingArab, pendingLatin); pendingArab = ""; pendingLatin = ""; } else { window.tambahBaitKosong("", text); } } else { if(pendingArab) pendingArab += " " + text; else if(pendingLatin) pendingLatin += " " + text; } }); if (pendingArab || pendingLatin) { window.tambahBaitKosong(pendingArab, pendingLatin); } document.getElementById('bulk-input').value = ''; document.getElementById('editor-baits-container').scrollIntoView({ behavior: 'smooth', block: 'end' }); }

        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');
            setTimeout(() => { splash.style.opacity = '0'; }, 4000);
            setTimeout(() => { splash.style.display = 'none'; }, 4800);
        });
    </script>
</body>
</html>
